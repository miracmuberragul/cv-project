<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>CV Oluşturucu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #dbeafe;
            font-family: 'Segoe UI', sans-serif;
        }

        .editor-container {
            display: grid;
            grid-template-columns: 45% 55%;
            gap: 2rem;
            min-height: 100vh;
            padding: 2rem;
        }

        .form-column, .preview-column {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow-y: auto;
            max-height: 95vh;
        }

        .form-section {
            margin-bottom: 2rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1.5rem;
        }

        .form-section h4 {
            color: #274877;
        }

        /* Şablon Seçici Stilleri */
        .template-selector {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .template-btn {
            margin-right: 0.5rem;
        }

        .template-btn.active {
            background-color: #274877;
            color: white;
            border-color: #274877;
        }

        /* Genel CV Önizleme */
        #cv-preview {
            display: block;
            margin: 0 auto;
            text-align: left;
            background-color: white;
            width: 100%;
            color: black;
            font-size: 14px;
            line-height: 1.6;
        }

        /* ŞABLON 1: KLASİK STİLLER */
        #cv-preview .classic-title {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        #cv-preview .classic-contact {
            text-align: center;
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 1.5rem;
        }

        #cv-preview .classic-section-title {
            font-weight: bold;
            color: #274877;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 5px;
            margin-top: 20px;
        }

        /* ŞABLON 2: MODERN STİLLER */
        #cv-preview .modern-container {
            display: grid;
            grid-template-columns: 1fr 2.5fr;
            gap: 1.5rem;
        }

        #cv-preview .modern-left-col {
            padding-right: 1.5rem;
            border-right: 1px solid #e2e8f0;
        }

        #cv-preview .modern-title {
            color: #1e3a8a;
            margin-bottom: 0.25rem;
            font-size: 1.8em;
        }

        #cv-preview .modern-contact-item {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
            word-wrap: break-word;
        }

        #cv-preview .modern-section-title {
            font-weight: bold;
            color: #1e3a8a;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        /* YENİ - ŞABLON 3: CANLI STİLLER */
        #cv-preview .vibrant-container {
            background-color: #f8fafc;
            padding: 1.5rem;
            border-radius: 6px;
        }

        #cv-preview .vibrant-header {
            text-align: center;
            border-bottom: 3px solid #0d9488;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        #cv-preview .vibrant-title {
            color: #115e59;
            font-size: 2.2em;
            margin: 0;
        }

        #cv-preview .vibrant-contact {
            color: #4b5563;
            margin-top: 0.5rem;
        }

        #cv-preview .vibrant-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        #cv-preview .vibrant-section-title {
            color: #0d9488;
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
        }

        #cv-preview .vibrant-section-title svg {
            margin-right: 8px;
        }

        #cv-preview .vibrant-list-item {
            margin-bottom: 0.25rem;
        }

        /* Chatbot stilleri aynı kaldı */
        #chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        #chat-toggle button {
            background-color: #274877;
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        #chat-toggle button:hover {
            transform: scale(1.1);
        }

        #chatbox {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 370px;
            max-height: 550px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            flex-direction: column;
        }

        .chat-header {
            background-color: #274877;
            color: white;
            padding: 12px 15px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            font-weight: bold;
        }

        #chat-messages {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
            height: 350px;
        }

        .chat-footer {
            padding: 10px;
            border-top: 1px solid #eee;
        }

        #chat-input {
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            resize: none;
        }

        #chat-send-button {
            margin-top: 5px;
            width: 100%;
        }

        .user-message {
            background: #dbeafe;
            color: #1e3a8a;
            padding: 10px 14px;
            border-radius: 15px 15px 0 15px;
            align-self: flex-end;
            margin-left: auto;
        }

        .bot-message {
            background: #f1f0f0;
            color: #333;
            padding: 10px 14px;
            border-radius: 15px 15px 15px 0;
            align-self: flex-start;
        }

        .loading-message, .error-message {
            background: #f1f0f0;
            padding: 10px 14px;
            border-radius: 15px 15px 15px 0;
            align-self: flex-start;
            font-style: italic;
            color: #666;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
        }

        #generate-summary, #add-experience, #add-education, #add-certificate, #add-language, #download-cv {
            background-color: #274877;
            border-color: #274877;
            color: white;
        }
        .language-selector {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .lang-btn {
            margin-right: 0.5rem;
        }

        .lang-btn.active {
            background-color: #274877;
            color: white;
            border-color: #274877;
        }

    </style>
</head>
<body>

<div class="editor-container">
    <!-- SOL SÜTUN: DÜZENLEME FORMLARI -->
    <div class="form-column">
        <h3>Edit Your CV</h3>
        <div class="my-3">
            <label for="import-pdf" class="form-label"><strong>Or Import from PDF:</strong></label>
            <div id="pdf-loading" style="display: none; color: gray;">Importing PDF...</div>
            <div id="pdf-loaded" style="display: none; color: green;">PDF imported.</div>
            <input type="file" id="import-pdf" class="form-control" accept=".pdf">
        </div>
        <hr>

        <div id="personal-info-form" class="form-section">
            <h4>Personal Information</h4>
            <input type="text" id="fullName" class="form-control mb-2" placeholder="Ad Soyad">
            <input type="email" id="email" class="form-control mb-2" placeholder="E-posta">
            <input type="tel" id="phone" class="form-control mb-2" placeholder="Telefon">
            <input type="text" id="address" class="form-control" placeholder="Adres">
        </div>

        <div id="summary-form" class="form-section">
            <h4>Summary</h4>
            <textarea id="summary" class="form-control" rows="5" placeholder="Profesyonel özetiniz..."></textarea>
            <div id="summary-loading" style="display: none; color: gray;">AI summary is being prepared...</div>
            <div id="summary-loaded" style="display: none; color: green;">AI summary prepared.</div>
            <button type="button" id="generate-summary" class="btn btn-primary mt-2">✨ Create with AI</button>
        </div>

        <div id="experience-form" class="form-section">
            <h4>Work Experience</h4>
            <div id="experience-entries"></div>
            <button id="add-experience" class="btn btn-secondary btn-sm mt-2">Add Experience</button>
        </div>

        <div id="education-form" class="form-section">
            <h4>Education</h4>
            <div id="education-entries"></div>
            <button id="add-education" class="btn btn-secondary btn-sm mt-2">Add Education</button>
        </div>

        <!-- YENİ: Sertifikalar Formu -->
        <div id="certificates-form" class="form-section">
            <h4>Certificates</h4>
            <div id="certificate-entries"></div>
            <button id="add-certificate" class="btn btn-secondary btn-sm mt-2">Add Certificate</button>
        </div>

        <!-- YENİ: Diller Formu -->
        <div id="languages-form" class="form-section">
            <h4>Languages</h4>
            <div id="language-entries"></div>
            <button id="add-language" class="btn btn-secondary btn-sm mt-2">Add Language</button>
        </div>

        <div id="skills-form" class="form-section">
            <h4>Skills</h4>
            <textarea id="skills" class="form-control" rows="3" placeholder="Örn: Python, Java, SQL..."></textarea>
        </div>

        <div id="hobbies-form" class="form-section">
            <h4>Hobbies</h4>
            <textarea id="hobbies" class="form-control" rows="3" placeholder="Kitap okuma, yüzme, müzik..."></textarea>
        </div>
    </div>

    <!-- SAĞ SÜTUN: CANLI ÖNİZLEME -->
    <div class="preview-column">

        <div class="template-selector">
            <h5>Select Template</h5>
            <button class="btn btn-outline-secondary template-btn active" data-template="classic">Classic</button>
            <button class="btn btn-outline-secondary template-btn" data-template="modern">Modern</button>
            <button class="btn btn-outline-secondary template-btn" data-template="vibrant">Live</button>
        </div>

        <div class="language-selector mt-3">
            <h5>Select Language</h5>
            <button id="tr-button" class="btn btn-outline-secondary lang-btn " data-lang="tr">Türkçe</button>
            <button id="en-button"  class="btn btn-outline-secondary lang-btn active" data-lang="en">English</button>
            <button id="de-button"  class="btn btn-outline-secondary lang-btn" data-lang="de">Deutsch</button>

            <div id="translating" style="display: none; color: gray;">Translating CV...</div>
            <div id="translated" style="display: none; color: green;">CV translated to selected language.</div>
        </div>

        <div id="cv-preview">
            <!-- Bu alan JavaScript tarafından dinamik olarak doldurulacak -->
        </div>
        <button id="save-cv-btn" class="btn btn-success mt-3" >Save</button>



        <button id="download-cv" class="btn btn-primary mt-3 w-100">Download as PDF</button>
    </div>

</div>

<!-- CHATBOT HTML'i (Değişiklik Yok) -->
<div id="chat-toggle">
    <button>💬</button>
</div>
<div id="chatbox">
    <div class="chat-header">CV Chatbot Assistant</div>
    <div id="chat-messages"></div>
    <div class="chat-footer">
        <form id="chat-form">
            <textarea id="chat-input" rows="2" placeholder="Ask a question..." required></textarea>
            <button type="submit" id="chat-send-button" class="btn btn-primary btn-sm">Send</button>
        </form>
    </div>
</div>


<!-- GÜNCELLENMİŞ SCRIPT -->
<script>
    // 1. TEMEL DEĞİŞKENLER VE CV VERİ YAPISI
    let currentTemplate = 'classic';
    let currentLanguage = 'en';

    // YENİ: cvData'ya sertifikalar ve diller eklendi
    let cvData = {
        personalInfo: {fullName: '', email: '', phone: '', address: ''},
        summary: '',
        workExperience: [],
        education: [],
        certificates: [],
        languages: [],
        skills: [],
        hobbies: [],
    };
    let allCvData = {
        'tr': {
            personalInfo: {},
            workExperience: [],
            education: [],
            certificates: [],
            languages: [],
            skills: [],
            hobbies: []
        }, // Boş Türkçe data
        'en': JSON.parse(JSON.stringify(cvData)), // Varsayılan boş cvData yapısını klonla, başlangıçta bu aktif olacak
        'de': {
            personalInfo: {},
            workExperience: [],
            education: [],
            certificates: [],
            languages: [],
            skills: [],
            hobbies: []
        }// Boş Almanca data
    };

    cvData = allCvData[currentLanguage];

    const formElements = {
        fullName: document.getElementById('fullName'),
        email: document.getElementById('email'),
        phone: document.getElementById('phone'),
        address: document.getElementById('address'),
        summary: document.getElementById('summary'),
        skills: document.getElementById('skills'),
        hobbies: document.getElementById('hobbies'),
        experienceEntries: document.getElementById('experience-entries'),
        addExperienceBtn: document.getElementById('add-experience'),
        educationEntries: document.getElementById('education-entries'),
        addEducationBtn: document.getElementById('add-education'),
        // YENİ: Sertifika ve Dil form elementleri
        certificateEntries: document.getElementById('certificate-entries'),
        addCertificateBtn: document.getElementById('add-certificate'),
        languageEntries: document.getElementById('language-entries'),
        addLanguageBtn: document.getElementById('add-language'),
    };

    // =================================================================
    // ŞABLON OLUŞTURUCU FONKSİYONLAR
    // =================================================================

    const templates = {
        // ŞABLON 1: KLASİK
        classic: function (data) {
            const experienceHtml = data.workExperience.map(exp => `<div class="mb-3"><strong>${exp.jobTitle || 'Ünvan'}</strong>, <span>${exp.company || 'Şirket'}</span><p style="white-space: pre-wrap; margin-top: 5px;">${exp.description || ''}</p></div>`).join('');
            const educationHtml = data.education.map(edu => `<p><strong>${edu.degree || 'Derece'}</strong> - ${edu.institution || 'Okul'}</p>`).join('');
            const certificatesHtml = data.certificates.map(cert => `<p><strong>${cert.name || 'Sertifika Adı'}</strong> - ${cert.issuer || 'Veren Kurum'}</p>`).join('');
            const languagesHtml = data.languages.map(lang => `<p><strong>${lang.name || 'Dil'}</strong>: ${lang.level || 'Seviye'}</p>`).join('');

            return `
                    <h3 class="classic-title">${data.personalInfo.fullName || 'Name Surname'}</h3>
                    <p class="classic-contact">${data.personalInfo.email} | ${data.personalInfo.phone} | ${data.personalInfo.address}</p>
                    <p class="classic-section-title">Summary</p><p>${data.summary || '...'}</p>
                    <p class="classic-section-title">Work Experience</p><div>${experienceHtml}</div>
                    <p class="classic-section-title">Education</p><div>${educationHtml}</div>
                    <p class="classic-section-title">Certificates</p><div>${certificatesHtml}</div>
                    <p class="classic-section-title">Languages</p><div>${languagesHtml}</div>
                    <p class="classic-section-title">Skills</p><p>${data.skills.join(', ')}</p>
                    <p class="classic-section-title">Hobbies</p><p>${data.hobbies.join(', ')}</p>
                `;
        },

        // ŞABLON 2: MODERN
        modern: function (data) {
            const experienceHtml = data.workExperience.map(exp => `<div class="mb-3"><strong>${exp.jobTitle || 'Ünvan'}</strong>, <span>${exp.company || 'Şirket'}</span><p style="white-space: pre-wrap; margin-top: 5px;">${exp.description || ''}</p></div>`).join('');
            const educationHtml = data.education.map(edu => `<p><strong>${edu.degree || 'Derece'}</strong> - ${edu.institution || 'Okul'}</p>`).join('');
            const certificatesHtml = data.certificates.map(cert => `<p><strong>${cert.name || 'Sertifika Adı'}</strong> - ${cert.issuer || 'Veren Kurum'}</p>`).join('');
            const languagesHtml = data.languages.map(lang => `<p class="vibrant-list-item">${lang.name || 'Dil'}: ${lang.level || 'Seviye'}</p>`).join('');

            return `
                    <div class="modern-container">
                        <div class="modern-left-col">
                            <h3 class="modern-title">${data.personalInfo.fullName || 'Name Surname'}</h3>
                            <p class="modern-section-title">Contact</p>
                            <span class="modern-contact-item">${data.personalInfo.email || ''}</span>
                            <span class="modern-contact-item">${data.personalInfo.phone || ''}</span>
                            <span class="modern-contact-item">${data.personalInfo.address || ''}</span>
                            <p class="modern-section-title">Skills</p><p>${data.skills.join(', ')}</p>
                            <p class="modern-section-title">Languages</p><div>${languagesHtml}</div>
                            <p class="modern-section-title">Hobbies</p><p>${data.hobbies.join(', ')}</p>
                        </div>
                        <div class="modern-right-col">
                            <p class="modern-section-title">Summary</p><p>${data.summary || '...'}</p>
                            <p class="modern-section-title">Work Experience </p><div>${experienceHtml}</div>
                            <p class="modern-section-title">Education</p><div>${educationHtml}</div>
                            <p class="modern-section-title">Certificates</p><div>${certificatesHtml}</div>
                        </div>
                    </div>
                `;
        },

        // YENİ - ŞABLON 3: CANLI
        vibrant: function (data) {
            const experienceHtml = data.workExperience.map(exp => `<div class="mb-3"><strong>${exp.jobTitle || 'Title'}</strong>, <span>${exp.company || 'Company'}</span><p style="white-space: pre-wrap; font-size: 0.9em; color: #4b5563;">${exp.description || ''}</p></div>`).join('');
            const educationHtml = data.education.map(edu => `<p class="vibrant-list-item"><strong>${edu.degree || 'Degree'}</strong>, ${edu.institution || 'Institution'}</p>`).join('');
            const certificatesHtml = data.certificates.map(cert => `<p class="vibrant-list-item"><strong>${cert.name || 'Certificate Name'}</strong> (${cert.issuer || 'Institution'})</p>`).join('');
            const languagesHtml = data.languages.map(lang => `<p class="vibrant-list-item">${lang.name || 'Dil'} - <strong>${lang.level || 'Level'}</strong></p>`).join('');
            const skillsHtml = data.skills.map(skill => `<span class="badge bg-secondary me-1 mb-1">${skill}</span>`).join('');

            const icon = (path) => `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi" viewBox="0 0 16 16">${path}</svg>`;
            const briefcaseIcon = icon('<path d="M8 1a2 2 0 0 0-2 2v2H5V3a3 3 0 0 1 6 0v2h-1V3a2 2 0 0 0-2-2zM4 6h8v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6z"/>');
            const gradCapIcon = icon('<path d="M8.211 2.047a.5.5 0 0 0-.422 0l-7.5 3.5a.5.5 0 0 0 .025.917l7.5 3a.5.5 0 0 0 .372 0l7.5-3a.5.5 0 0 0 .025-.917l-7.5-3.5zM8 5.482 1.5 8 8 10.518 14.5 8 8 5.482z"/><path d="M1 9.583v2.5a.5.5 0 0 0 .5.5h13a.5.5 0 0 0 .5-.5v-2.5l-7 3.262-7-3.262zM1 12.5a.5.5 0 0 0 .5.5h13a.5.5 0 0 0 .5-.5v-1.5a.5.5 0 0 0-1 0V12a.5.5 0 0 1-.5.5h-12a.5.5 0 0 1-.5-.5v-1.5a.5.5 0 0 0-1 0v1.5z"/>');
            const certIcon = icon('<path d="M4.54.146A.5.5 0 0 1 5 .5v1.618a.5.5 0 0 1-.447.498l-1.884.314a.5.5 0 0 1-.577-.497V.5a.5.5 0 0 1 .5-.5h.928a.5.5 0 0 1 .192.041zm4.94 0a.5.5 0 0 1 .5.5v4.062a.5.5 0 0 1-.447.498l-1.884.314a.5.5 0 0 1-.577-.497V.5a.5.5 0 0 1 .5-.5h.928a.5.5 0 0 1 .192.041zM2.5 1a.5.5 0 0 0-.5.5v13a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5v-13a.5.5 0 0 0-.5-.5H2.5z"/>');
            const langIcon = icon('<path d="M4.52 7.228A.5.5 0 0 0 4 7.5v1.59a.5.5 0 0 0 .52.472l.43.086a.5.5 0 0 1 .45.49v.443a.5.5 0 0 0 .7.47L7 9.58V7.5a.5.5 0 0 0-.5-.5h-2a.5.5 0 0 0-.48.228zM1 1.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 .5.5v13a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-13z"/>');
            const toolsIcon = icon('<path d="M14.5 5.5a.5.5 0 0 1 .5.5v1.5a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm-11-1a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5zm3.5.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>');

            return `
                    <div class="vibrant-container">
                        <header class="vibrant-header">
                            <h2 class="vibrant-title">${data.personalInfo.fullName || 'Name Surname'}</h2>
                            <div class="vibrant-contact">${data.personalInfo.email} • ${data.personalInfo.phone}</div>
                        </header>
                        <div>
                            <p>${data.summary || '...'}</p>
                        </div>
                        <div class="vibrant-body">
                            <div>
                                <h5 class="vibrant-section-title">${briefcaseIcon}Work Experience</h5>
                                ${experienceHtml}
                                <h5 class="vibrant-section-title mt-4">${gradCapIcon}Education</h5>
                                ${educationHtml}
                            </div>
                            <div>
                                <h5 class="vibrant-section-title">${certIcon}Certificates</h5>
                                ${certificatesHtml}
                                <h5 class="vibrant-section-title mt-4">${langIcon}Language</h5>
                                ${languagesHtml}
                                <h5 class="vibrant-section-title mt-4">${toolsIcon}Skills</h5>
                                ${skillsHtml}
                            </div>
                        </div>
                    </div>
                `;
        }
    };

    // =================================================================
    // RENDER FONKSİYONLARI
    // =================================================================

    function renderPreview() {
        const previewContainer = document.getElementById('cv-preview');
        if (templates[currentTemplate]) {
            previewContainer.innerHTML = templates[currentTemplate](cvData);
        } else {
            previewContainer.innerHTML = '<p class="text-danger">Şablon bulunamadı.</p>';
        }
    }

    function updateForms() {
        formElements.fullName.value = cvData.personalInfo.fullName;
        formElements.email.value = cvData.personalInfo.email;
        formElements.phone.value = cvData.personalInfo.phone;
        formElements.address.value = cvData.personalInfo.address;
        formElements.summary.value = cvData.summary;
        formElements.skills.value = cvData.skills.join(', ');
        formElements.hobbies.value = cvData.hobbies.join(', ');

        renderExperienceForm();
        renderEducationForm();
        renderCertificatesForm();
        renderLanguagesForm();
    }

    // --- Dinamik Form Alanı Render Fonksiyonları ---
    function renderDynamicForm(container, dataArray, fields, type) {
        container.innerHTML = '';
        dataArray.forEach((item, index) => {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'card card-body mb-2';
            let inputsHtml = '';
            fields.forEach(field => {
                if (field.tag === 'textarea') {
                    inputsHtml += `<textarea class="form-control" data-index="${index}" data-field="${field.name}" data-type="${type}" rows="3" placeholder="${field.placeholder}">${item[field.name] || ''}</textarea>`;
                } else {
                    inputsHtml += `<input type="text" class="form-control mb-1" data-index="${index}" data-field="${field.name}" data-type="${type}" value="${item[field.name] || ''}" placeholder="${field.placeholder}">`;
                }
            });
            entryDiv.innerHTML = inputsHtml;
            container.appendChild(entryDiv);
        });
    }

    function renderExperienceForm() {
        renderDynamicForm(formElements.experienceEntries, cvData.workExperience, [
            {name: 'jobTitle', placeholder: 'Ünvan'},
            {name: 'company', placeholder: 'Şirket'},
            {name: 'description', placeholder: 'Açıklama...', tag: 'textarea'}
        ], 'experience');
    }

    function renderEducationForm() {
        renderDynamicForm(formElements.educationEntries, cvData.education, [
            {name: 'degree', placeholder: 'Derece'},
            {name: 'institution', placeholder: 'Okul'}
        ], 'education');
    }

    function renderCertificatesForm() {
        renderDynamicForm(formElements.certificateEntries, cvData.certificates, [
            {name: 'name', placeholder: 'Sertifika Adı'},
            {name: 'issuer', placeholder: 'Veren Kurum'}
        ], 'certificate');
    }

    function renderLanguagesForm() {
        renderDynamicForm(formElements.languageEntries, cvData.languages, [
            {name: 'name', placeholder: 'Dil (Örn: İngilizce)'},
            {name: 'level', placeholder: 'Seviye (Örn: C1 - İleri)'}
        ], 'language');
    }

    // =================================================================
    // EVENT LISTENERS
    // =================================================================

    function handleFormInput(e) {
        const {id, value} = e.target;
        const dataType = e.target.closest('.form-section')?.id;

        if (dataType === 'personal-info-form') cvData.personalInfo[id] = value;
        else if (id === 'summary') cvData.summary = value;
        else if (id === 'skills') cvData.skills = value.split(',').map(s => s.trim());
        else if (id === 'hobbies') cvData.hobbies = value.split(',').map(h => h.trim());

        renderPreview();
    }

    function handleDynamicInput(e) {
        const {index, field, type} = e.target.dataset;
        if (index === undefined || !field || !type) return;

        const dataMap = {
            experience: cvData.workExperience,
            education: cvData.education,
            certificate: cvData.certificates,
            language: cvData.languages,
        };

        if (dataMap[type]) {
            dataMap[type][index][field] = e.target.value;
            renderPreview();
        }
    }

    document.getElementById('personal-info-form').addEventListener('input', handleFormInput);
    document.getElementById('summary-form').addEventListener('input', handleFormInput);
    document.getElementById('skills-form').addEventListener('input', handleFormInput);
    document.getElementById('hobbies-form').addEventListener('input', handleFormInput);

    document.getElementById('experience-entries').addEventListener('input', handleDynamicInput);
    document.getElementById('education-entries').addEventListener('input', handleDynamicInput);
    document.getElementById('certificate-entries').addEventListener('input', handleDynamicInput);
    document.getElementById('language-entries').addEventListener('input', handleDynamicInput);

    formElements.addExperienceBtn.addEventListener('click', () => {
        cvData.workExperience.push({jobTitle: '', company: '', description: ''});
        updateForms();
        renderPreview();
    });
    formElements.addEducationBtn.addEventListener('click', () => {
        cvData.education.push({degree: '', institution: ''});
        updateForms();
        renderPreview();
    });
    formElements.addCertificateBtn.addEventListener('click', () => {
        cvData.certificates.push({name: '', issuer: ''});
        updateForms();
        renderPreview();
    });
    formElements.addLanguageBtn.addEventListener('click', () => {
        cvData.languages.push({name: '', level: ''});
        updateForms();
        renderPreview();
    });

    document.querySelectorAll('.template-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.template-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            currentTemplate = e.target.dataset.template;
            renderPreview();
        });
    });
    document.querySelectorAll('.lang-btn').forEach(btn => {

        btn.addEventListener('click', async (e) => {
            const newLanguage = e.target.dataset.lang;
            document.getElementById("translating").style.display = "block";


            // Eğer zaten seçili dil ise veya bir çeviri işlemi devam ediyorsa bir şey yapma
            if (newLanguage === currentLanguage) return;

            // Butonların aktifliğini güncelle
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');


            try {
                // Backend'e çeviri isteği gönder
                const response = await fetch('translate-cv/', { // urls.py'deki path ile eşleşmeli
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        cv_data: cvData, // Mevcut CV verilerini gönder
                        target_language: newLanguage
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Çeviri sırasında bir hata oluştu.');
                }

                const translatedData = await response.json();

                // Çevrilmiş verileri mevcut cvData objesine aktar
                // Eğer allCvData kullanıyorsanız:
                allCvData[newLanguage] = translatedData;
                currentLanguage = newLanguage;
                cvData = allCvData[currentLanguage]; // Aktif cvData'yı güncelle

                updateForms(); // Formları çevrilmiş verilerle güncelle
                renderPreview(); // Önizlemeyi çevrilmiş verilerle güncelle

                document.getElementById("translating").style.display = "none";
                document.getElementById("translated").style.display = "block";

            } catch (error) {
                console.error('CV çeviri hatası:', error);
                alert(`Çeviri hatası: ${error.message}`);
                // Hata durumunda, butonun aktifliğini eski dile geri getirebilirsiniz
                document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`.lang-btn[data-lang="${currentLanguage}"]`).classList.add('active');
            }
        });
    });

    // =================================================================
    // API VE DOSYA İŞLEMLERİ
    // =================================================================

    document.getElementById("generate-summary").addEventListener("click", function () {
        document.getElementById("summary-loading").style.display = "block";
        // YENİ: Sertifika ve dil verileri eklendi
        const payload = {
            name: cvData.personalInfo.fullName,
            skills: cvData.skills.join(', '),
            education: cvData.education.map(e => `${e.degree} at ${e.institution}`).join('; '),
            experience: cvData.workExperience.map(e => `${e.jobTitle} at ${e.company}`).join('; '),
            certificates: cvData.certificates.map(c => c.name).join('; '),
            languages: cvData.languages.map(l => l.name).join('; '),
        };

        fetch('generate-summary/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
            body: JSON.stringify(payload)
        })
            .then(response => response.ok ? response.json() : Promise.reject('Sunucu hatası'))
            .then(data => {
                cvData.summary = data.summary;
                updateForms();
                renderPreview();
                document.getElementById("summary-loading").style.display = "none";
                document.getElementById("summary-loaded").style.display = "block";
            })
            .catch(error => {
                console.error('AI Özet Hatası:', error);
                document.getElementById("summary-loading").style.display = "none";
            });
    });

    document.getElementById('import-pdf').addEventListener('change', async (e) => {
        document.getElementById("pdf-loading").style.display = "block";
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('pdf_file', file);
        try {
            const response = await fetch("{% url 'parse_pdf_for_edit' %}", {method: "POST", body: formData});
            if (!response.ok) throw new Error(await response.text());

            const data = await response.json();
            // YENİ: Sertifika ve dil verileri alınıyor
            cvData = {
                personalInfo: data.personalInfo || {fullName: '', email: '', phone: '', address: ''},
                summary: data.summary || '',
                workExperience: data.workExperience || [],
                education: data.education || [],
                certificates: data.certificates || [],
                languages: data.languages || [],
                skills: data.skills || [],
                hobbies: data.hobbies || []
            };
            updateForms();
            renderPreview();
            document.getElementById("pdf-loading").style.display = "none";
            document.getElementById("pdf-loaded").style.display = "block";
        } catch (error) {
            document.getElementById("pdf-loading").style.display = "none";
            alert(`Hata: ${error.message}`);
        }
    });

    document.getElementById("download-cv").addEventListener("click", function () {
        const element = document.getElementById("cv-preview");
        const options = {
            margin: [0.5, 0.5, 0.5, 0.5],
            filename: `${(cvData.personalInfo.fullName || 'CV').replace(/ /g, '_')}.pdf`,
            image: {type: 'jpeg', quality: 0.98},
            html2canvas: {scale: 2, useCORS: true, scrollY: 0, windowHeight: element.scrollHeight},
            jsPDF: {unit: 'in', format: 'a4', orientation: 'portrait'}
        };
        html2pdf().set(options).from(element).save();
    });


    // =================================================================
    // CHATBOT KISMI (Değişiklik Yok)
    // =================================================================
    function getCookie(name) {
        let cV = null;
        if (document.cookie && document.cookie !== '') {
            const cs = document.cookie.split(';');
            for (let i = 0; i < cs.length; i++) {
                const c = cs[i].trim();
                if (c.substring(0, name.length + 1) === (name + '=')) {
                    cV = decodeURIComponent(c.substring(name.length + 1));
                    break;
                }
            }
        }
        return cV;
    }

    function toggleChat() {
        const b = document.getElementById("chatbox");
        b.style.display = b.style.display === "none" || b.style.display === "" ? "flex" : "none";
    }

    async function sendChat() {
        const i = document.getElementById("chat-input");
        const m = i.value.trim();
        if (!m) return;
        const cM = document.getElementById("chat-messages");
        appendMessage(m, 'user');
        i.value = "";
        const lE = appendMessage('...', 'loading');
        try {
            const r = await fetch("/api/chatbot/", {
                method: "POST",
                headers: {"Content-Type": "application/json", "X-CSRFToken": getCookie('csrftoken')},
                body: JSON.stringify({question: m})

            });
            console.log(r)
            if (!r.ok) {
                const eD = await r.json();
                throw new Error(`Sunucu hatası: ${r.status} - ${eD.error || r.statusText}`);
            }
            const d = await r.json();
            lE.remove();
            appendMessage(d.answer || "Cevap alınamadı.", 'bot');
        } catch (e) {
            console.error("Chat Hatası:", e);
            lE.remove();
            appendMessage(`Bir hata oluştu: ${e.message}.`, 'error');
        }
    }

    function appendMessage(t, type) {
        const cM = document.getElementById("chat-messages");
        const mW = document.createElement("div");
        mW.classList.add('chat-message');
        const mB = document.createElement("div");
        mB.textContent = t;
        if (type === 'user') {
            mB.classList.add('user-message');
        } else if (type === 'bot') {
            mB.classList.add('bot-message');
        } else if (type === 'loading') {
            mB.classList.add('loading-message');
        } else if (type === 'error') {
            mB.classList.add('error-message');
        }
        mW.appendChild(mB);
        cM.appendChild(mW);
        cM.scrollTop = cM.scrollHeight;
        return mW;
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('chat-toggle').addEventListener('click', toggleChat);
        document.getElementById('chat-form').addEventListener('submit', function (e) {
            e.preventDefault();
            sendChat();
        });
    });
    document.getElementById('save-cv-btn').addEventListener('click', async () => {
    // 1. CV'nin HTML içeriğini al
    const cvHtmlContent = document.getElementById('cv-preview').innerHTML;

    if (!cvHtmlContent.trim()) {
        alert('Kaydedilecek CV içeriği boş.');
        return;
    }

    try {
        const response = await fetch('/save-cv/', { // urls.py'daki path ile eşleşmeli
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken') // CSRF token'ı eklediğinizden emin olun
            },
            body: JSON.stringify({ html_content: cvHtmlContent })
        });

        const data = await response.json();

        if (response.ok) {
            alert(data.message); // "CV başarıyla kaydedildi!"
        } else {
            alert('Kaydetme hatası: ' + data.message);
            console.error('Kaydetme hatası:', data.message);
        }
    } catch (error) {
        alert('Ağ hatası veya sunucuya ulaşılamadı.');
        console.error('Fetch hatası:', error);
    }
});

// getCookie fonksiyonunu da eklediğinizden emin olun, daha önceki cevabımda vermiştim.
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

    // Sayfa yüklendiğinde ilk render'ı yap
    updateForms();
    renderPreview();
</script>

<script src="https://raw.githack.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js"></script>

</body>
</html>