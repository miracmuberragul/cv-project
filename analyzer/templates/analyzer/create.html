 <!-- templates/analyzer/create.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>CV OluÅŸturucu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #dbeafe; font-family: 'Segoe UI', sans-serif; }
        .editor-container {
            display: grid;
            grid-template-columns: 45% 55%; /* Sol form, saÄŸ Ã¶nizleme */
            gap: 2rem;
            min-height: 100vh;
            padding: 2rem;
        }
        .form-column { background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow-y: auto; }
        .preview-column { background: #fff; padding: 2.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); font-size: 14px; line-height: 1.6; }
        .form-section { margin-bottom: 2rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 1.5rem; }
        .form-section h4 { color: #274877; }
        #cv-preview h3 { color: #2c3e50; text-align: center; }
        #cv-preview .section-title { font-weight: bold; color: #274877; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; margin-top: 20px; }
        /* Chatbot stilleri aynÄ± kaldÄ± */
        #chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        #chat-toggle button {
            background-color: #274877;
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
        }

        #chat-toggle button:hover {
            transform: scale(1.1);
        }

        #chatbox {
            display: none;
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 370px;
            max-height: 550px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            flex-direction: column; /* Sayfa yÃ¼klendiÄŸinde varsayÄ±lanÄ± flex olarak tutmak iÃ§in */
        }

        .chat-header {
            background-color: #274877;
            color: white;
            padding: 12px 15px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            font-weight: bold;
        }

        #chat-messages {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
            height: 350px;
        }

        .chat-footer {
            padding: 10px;
            border-top: 1px solid #eee;
        }

        #chat-input {
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            resize: none;
        }

        #chat-send-button {
            margin-top: 5px;
            width: 100%;
        }

        .chat-message {
            margin-bottom: 10px;
            max-width: 85%;
            word-wrap: break-word;
        }

        .user-message {
            background: #dbeafe;
            color: #1e3a8a;
            padding: 10px 14px;
            border-radius: 15px 15px 0 15px;
            align-self: flex-end;
            margin-left: auto;
        }

        .bot-message {
            background: #f1f0f0;
            color: #333;
            padding: 10px 14px;
            border-radius: 15px 15px 15px 0;
            align-self: flex-start;
        }

        .loading-message, .error-message {
            background: #f1f0f0;
            padding: 10px 14px;
            border-radius: 15px 15px 15px 0;
            align-self: flex-start;
            font-style: italic;
            color: #666;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
        }
        #generate-summary{
            background-color: #1e3a8a;
        }
        #add-experience{
            background-color: #1e3a8a;
        }
        #add-education{
            background-color: #1e3a8a;
        }
    </style>
</head>
<body>

    <div class="editor-container">
        <!-- SOL SÃœTUN: DÃœZENLEME FORMLARI -->
        <div class="form-column">
            <h3>CV'ni DÃ¼zenle</h3>
            <div class="my-3">
                <label for="import-pdf" class="form-label"><strong>Veya PDF'ten Ä°Ã§eri Aktar:</strong></label>
                    <div id="pdf-loading" style="display: none; color: gray; font-style: italic;">
                      PDF iÃ§eri aktarÄ±lÄ±yor...
                    </div>
                    <div id="pdf-loaded" style="display: none; color: gray; font-style: italic;">
                          PDF iÃ§eri aktarÄ±ldÄ±.
                    </div>
                <input type="file" id="import-pdf" class="form-control" accept=".pdf">
            </div>
            <hr>

            <!-- KiÅŸisel Bilgiler Formu -->
            <div id="personal-info-form" class="form-section">
                <h4>KiÅŸisel Bilgiler</h4>
                <input type="text" id="fullName" class="form-control mb-2" placeholder="Ad Soyad">
                <input type="email" id="email" class="form-control mb-2" placeholder="E-posta">
                <input type="tel" id="phone" class="form-control mb-2" placeholder="Telefon">
                <input type="text" id="address" class="form-control" placeholder="Adres">
            </div>

            <!-- Ã–zet Formu -->
            <div id="summary-form" class="form-section">
                <h4>Ã–zet</h4>
                <textarea id="summary" class="form-control" rows="5" placeholder="Profesyonel Ã¶zetiniz..."></textarea>
                    <div id="summary-loading" style="display: none; color: gray; font-style: italic;">
                      AI Ã¶zeti hazÄ±rlanÄ±yor...
                    </div>
                    <div id="summary-loaded" style="display: none; color: gray; font-style: italic;">
                        AI Ã¶zeti hazÄ±rlandÄ±.
                    </div>
                 <button type="button" id="generate-summary" class="btn btn-primary mt-2" >âœ¨ AI ile OluÅŸtur</button>
            </div>

            <!-- Ä°ÅŸ Deneyimi Formu -->
            <div id="experience-form" class="form-section">
                <h4>Ä°ÅŸ Deneyimi</h4>
                <div id="experience-entries"></div>
                <button id="add-experience" class="btn btn-secondary btn-sm mt-2">Deneyim Ekle</button>
            </div>
            <!-- EÄŸitim Formu -->
            <div id="education-form" class="form-section">
                <h4>EÄŸitim</h4>
                <div id="education-entries"></div>
                <button id="add-education" class="btn btn-secondary btn-sm mt-2">EÄŸitim Ekle</button>
            </div>

            <!-- Yetenekler -->
            <div id="skills-form" class="form-section">
                <h4>Yetenekler</h4>
                <textarea id="skills" class="form-control" rows="3" placeholder="Ã–rn: Python, Java, SQL..."></textarea>
            </div>

            <!-- Hobiler -->
            <div id="hobbies-form" class="form-section">
                <h4>Hobiler</h4>
                <textarea id="hobbies" class="form-control" rows="3" placeholder="Kitap okuma, yÃ¼zme, mÃ¼zik..."></textarea>
            </div>


        </div>

        <!-- SAÄž SÃœTUN: CANLI Ã–NÄ°ZLEME -->
        <div class="preview-column">
            <div id="cv-preview">
                <h3 id="preview-fullName">AdÄ±nÄ±z SoyadÄ±nÄ±z</h3>
                <p id="preview-contact" class="text-center small text-muted"></p>

                <p class="section-title">Ã–zet</p>
                <p id="preview-summary">Profesyonel Ã¶zetiniz burada gÃ¶rÃ¼necek.</p>

                <p class="section-title">Ä°ÅŸ Deneyimi</p>
                <div id="preview-experience"></div>

                <p class="section-title">EÄŸitim</p>
                <div id="preview-education"></div>

                <p class="section-title">Yetenekler</p>
                <p id="preview-skills"></p>

                <p class="section-title">Hobiler</p>
                <p id="preview-hobbies"></p>

            </div>
        </div>
        </div> <div id="chat-toggle">
                <button>ðŸ’¬</button>
            </div>

            <div id="chatbox">
                <div class="chat-header">CV Chatbot Asistant</div>
                <div id="chat-messages"></div>
                <div class="chat-footer">
                    <form id="chat-form">
                        <textarea id="chat-input" rows="2" placeholder="Ask a question..." required></textarea>
                        <button type="submit" id="chat-send-button" class="btn btn-primary btn-sm">Send</button>
                    </form>
                </div>
            </div>
    </div>

    <script>
       // create.html iÃ§indeki <script> etiketinin iÃ§i

        // 1. TEMEL DEÄžÄ°ÅžKENLER VE CV VERÄ° YAPISI
        let cvData = {
            personalInfo: { fullName: '', email: '', phone: '', address: '' },
            summary: '',
            workExperience: [],
            education: [],
            skills: [],
            hobbies: [],
        };

        const formElements = {
            fullName: document.getElementById('fullName'),
            email: document.getElementById('email'),
            phone: document.getElementById('phone'),
            address: document.getElementById('address'),
            summary: document.getElementById('summary'),
            experienceEntries: document.getElementById('experience-entries'),
            addExperienceBtn: document.getElementById('add-experience'),
        };

        const previewElements = {
            fullName: document.getElementById('preview-fullName'),
            contact: document.getElementById('preview-contact'),
            summary: document.getElementById('preview-summary'),
            experience: document.getElementById('preview-experience'),

        };


        // 2. RENDER FONKSÄ°YONLARI (Veriyi HTML'e dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r)

        function renderAll() {
            renderPersonalInfo();
            renderSummary();
            renderExperience();
            renderEducation();
            renderSkills();
            renderHobbies();
        }

        function renderPersonalInfo() {
            // Formu doldur
            formElements.fullName.value = cvData.personalInfo.fullName;
            formElements.email.value = cvData.personalInfo.email;
            formElements.phone.value = cvData.personalInfo.phone;
            formElements.address.value = cvData.personalInfo.address;

            // Ã–nizlemeyi gÃ¼ncelle
            previewElements.fullName.textContent = cvData.personalInfo.fullName || 'AdÄ±nÄ±z SoyadÄ±nÄ±z';
            previewElements.contact.textContent = `${cvData.personalInfo.email} | ${cvData.personalInfo.phone} | ${cvData.personalInfo.address}`;
        }

        function renderSummary() {
            formElements.summary.value = cvData.summary;
            previewElements.summary.textContent = cvData.summary || 'Profesyonel Ã¶zetiniz burada gÃ¶rÃ¼necek.';
        }

        function renderExperience() {
            // FormlarÄ± ve Ã¶nizlemeyi temizle
            formElements.experienceEntries.innerHTML = '';
            previewElements.experience.innerHTML = '';

            cvData.workExperience.forEach((exp, index) => {

                const entryDiv = document.createElement('div');
                entryDiv.className = 'card card-body mb-2';
                entryDiv.innerHTML = `
                    <input type="text" class="form-control mb-1" data-index="${index}" data-field="jobTitle" value="${exp.jobTitle}" placeholder="Ãœnvan">
                    <input type="text" class="form-control mb-1" data-index="${index}" data-field="company" value="${exp.company}" placeholder="Åžirket">
                    <textarea class="form-control" data-index="${index}" data-field="description" rows="3" placeholder="AÃ§Ä±klama...">${exp.description}</textarea>
                `;
                formElements.experienceEntries.appendChild(entryDiv);

                // Ã–nizleme alanÄ±nÄ± oluÅŸtur
                const previewDiv = document.createElement('div');
                previewDiv.className = 'mb-3';
                previewDiv.innerHTML = `
                    <strong>${exp.jobTitle || 'Ãœnvan'}</strong>, <span>${exp.company || 'Åžirket'}</span>
                    <p style="white-space: pre-wrap;">${exp.description || ''}</p>
                `;
                previewElements.experience.appendChild(previewDiv);
            });
        }
        function renderEducation() {
            const container = document.getElementById('education-entries');
            const preview = document.getElementById('preview-education');
            container.innerHTML = '';
            preview.innerHTML = '';

            cvData.education.forEach((edu, index) => {
                const div = document.createElement('div');
                div.className = 'card card-body mb-2';
                div.innerHTML = `
                    <input type="text" class="form-control mb-1" data-index="${index}" data-field="degree" data-type="education" value="${edu.degree}" placeholder="Derece">
                    <input type="text" class="form-control mb-1" data-index="${index}" data-field="institution" data-type="education" value="${edu.institution}" placeholder="Okul">
                `;
                container.appendChild(div);

                const prev = document.createElement('p');
                prev.innerHTML = `<strong>${edu.degree || ''}</strong> - ${edu.institution || ''}`;
                preview.appendChild(prev);
            });
        }

        function renderSkills() {
            document.getElementById('skills').value = cvData.skills.join(', ');
            document.getElementById('preview-skills').textContent = cvData.skills.join(', ');
        }

        function renderHobbies() {
            document.getElementById('hobbies').value = cvData.hobbies.join(', ');
            document.getElementById('preview-hobbies').textContent = cvData.hobbies.join(', ');
        }



        // 3. EVENT LISTENERS (KullanÄ±cÄ± etkileÅŸimlerini yakalar)

        // Form alanlarÄ±ndaki genel deÄŸiÅŸiklikler
        document.getElementById('personal-info-form').addEventListener('input', (e) => {
            cvData.personalInfo[e.target.id] = e.target.value;
            renderPersonalInfo();
        });

        formElements.summary.addEventListener('input', () => {
            cvData.summary = formElements.summary.value;
            renderSummary();
        });

        // Ä°ÅŸ deneyimi gibi dinamik alanlar iÃ§in
        formElements.experienceEntries.addEventListener('input', (e) => {
            const index = e.target.dataset.index;
            const field = e.target.dataset.field;

            const caretPosition = e.target.selectionStart;//imleÃ§ pozisyonunu korur.

            if (index !== undefined && field) {
                cvData.workExperience[index][field] = e.target.value;
                renderExperience(); // TÃ¼m deneyim bÃ¶lÃ¼mÃ¼nÃ¼ yeniden Ã§iz
            }
            const updatedInputs = formElements.experienceEntries.querySelectorAll(`[data-index="${index}"][data-field="${field}"]`);
            if (updatedInputs.length > 0) {
                const newInput = updatedInputs[0];
                newInput.focus();
                newInput.setSelectionRange(caretPosition, caretPosition);
            }
        });

        formElements.addExperienceBtn.addEventListener('click', () => {
            cvData.workExperience.push({ jobTitle: '', company: '', description: '' });
            renderExperience();
        });
        document.getElementById('skills').addEventListener('input', (e) => {
            cvData.skills = e.target.value.split(',').map(s => s.trim());
            renderSkills();
        });

        document.getElementById('hobbies').addEventListener('input', (e) => {
            cvData.hobbies = e.target.value.split(',').map(h => h.trim());
            renderHobbies();
        });

        document.getElementById('education-entries').addEventListener('input', (e) => {
            const index = e.target.dataset.index;
            const field = e.target.dataset.field;
            const type = e.target.dataset.type;

            if (type === 'education' && index !== undefined && field) {
                cvData.education[index][field] = e.target.value;
                renderEducation();
            }
        });

        document.getElementById('add-education').addEventListener('click', () => {
            cvData.education.push({ degree: '', institution: '' });
            renderEducation();
        });
        document.getElementById("generate-summary").addEventListener("click", function () {
            document.getElementById("summary-loading").style.display = "block";
            document.getElementById("summary-loaded").style.display = "none";
            // `cvData` objesinden gÃ¼ncel verileri al
            const currentName = cvData.personalInfo.fullName;
            // Yetenekleri virgÃ¼lle ayrÄ±lmÄ±ÅŸ bir stringe Ã§evir
            const currentSkills = cvData.skills.join(', ');

            // EÄŸitim ve deneyim bilgilerini daha anlamlÄ± bir stringe dÃ¶nÃ¼ÅŸtÃ¼rÃ¼n
            // Ã–rneÄŸin: "BoÄŸaziÃ§i Ãœniversitesi - Bilgisayar MÃ¼hendisliÄŸi; X Åžirketi - YazÄ±lÄ±m MÃ¼hendisi;"
            const currentEducation = cvData.education.map(edu => `${edu.degree} - ${edu.institution}`).join('; ');
            const currentExperience = cvData.workExperience.map(exp => `${exp.jobTitle} at ${exp.company}`).join('; ');


            fetch('generate-summary/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
              },
              body: JSON.stringify({
                name: currentName,
                skills: currentSkills,
                education: currentEducation,
                experience: currentExperience
              })
            })
            .then(response => {
                // Hata durumlarÄ±nÄ± daha iyi yakalamak iÃ§in
                if (!response.ok) {
                    // Sunucu tarafÄ±ndan dÃ¶nen hatayÄ± JSON olarak almayÄ± dene
                    return response.json().then(err => { throw new Error(err.error || 'Bilinmeyen sunucu hatasÄ±'); });
                }
                return response.json();
            })
            .then(data => {
              document.getElementById("summary").value = data.summary;
              // CV data'yÄ± da gÃ¼ncelle ki Ã¶nizleme de deÄŸiÅŸsin
              cvData.summary = data.summary;
              renderSummary(); // Summary alanÄ±nÄ± yeniden render et
              document.getElementById("summary-loading").style.display = "none";
              document.getElementById("summary-loaded").style.display = "block";

            })
            .catch(error => {
              console.error('AI Ã–zet HatasÄ±:', error);
              alert(`AI Ã¶zeti alÄ±namadÄ±: ${error.message || error}. LÃ¼tfen tÃ¼m alanlarÄ± doldurduÄŸunuzdan emin olun.`);
              document.getElementById("summary-loading").style.display = "none";
            });

        });



        // 4. PDF Ä°Ã‡ERÄ° AKTARMA

        const importPdfInput = document.getElementById('import-pdf');
        importPdfInput.addEventListener('change', async (e) => {
            document.getElementById("pdf-loading").style.display = "block";
            document.getElementById("pdf-loaded").style.display = "none";
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('pdf_file', file);

            try {
                const response = await fetch("{% url 'parse_pdf_for_edit' %}", {
                    method: "POST",
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Bilinmeyen bir hata oluÅŸtu.');
                }

                const data = await response.json();
                cvData = {
                    personalInfo: data.personalInfo || { fullName: '', email: '', phone: '', address: '' },
                    summary: data.summary || '',
                    workExperience: data.workExperience || [],
                    education: data.education || [],
                    skills: data.skills || [],
                    hobbies: data.hobbies || []
                };
                renderAll(); // TÃ¼m arayÃ¼zÃ¼ yeni veri ile yeniden Ã§iz
                document.getElementById("pdf-loading").style.display = "none";
                document.getElementById("pdf-loaded").style.display = "block";

            } catch (error) {
                document.getElementById("pdf-loading").style.display = "none";
                alert(`Hata: ${error.message}`);
            }
        });

        // CHATBOT KISMI
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        function toggleChat() {
            const box = document.getElementById("chatbox");
            box.style.display = box.style.display === "none" || box.style.display === "" ? "flex" : "none";
        }

        async function sendChat() {
            const input = document.getElementById("chat-input");
            const message = input.value.trim();
            if (!message) return;

            const chatMessages = document.getElementById("chat-messages");
            appendMessage(message, 'user');
            input.value = "";

            const loadingElement = appendMessage('...', 'loading');

            try {
                const response = await fetch("/api/chatbot/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie('csrftoken')
                    },
                    body: JSON.stringify({ question: message })
                });

                if (!response.ok) {
                    const errorData = await response.json(); // Hata JSON'Ä±nÄ± yakalamaya Ã§alÄ±ÅŸ
                    throw new Error(`Sunucu hatasÄ±: ${response.status} - ${errorData.error || response.statusText}`);
                }

                const data = await response.json();
                loadingElement.remove();
                appendMessage(data.answer || "AnlaÅŸÄ±lÄ±r bir cevap alÄ±namadÄ±.", 'bot');
            } catch (error) {
                console.error("Chat HatasÄ±:", error);
                loadingElement.remove();
                appendMessage(`ÃœzgÃ¼nÃ¼m, bir hata oluÅŸtu: ${error.message}. LÃ¼tfen daha sonra tekrar deneyin.`, 'error');
            }
        }

        function appendMessage(text, type) {
            const chatMessages = document.getElementById("chat-messages");
            const messageWrapper = document.createElement("div");
            messageWrapper.classList.add('chat-message');

            const messageBubble = document.createElement("div");
            messageBubble.textContent = text;

            if (type === 'user') {
                messageBubble.classList.add('user-message');
            } else if (type === 'bot') {
                messageBubble.classList.add('bot-message');
            } else if (type === 'loading') {
                messageBubble.classList.add('loading-message');
            } else if (type === 'error') {
                messageBubble.classList.add('error-message');
            }

            messageWrapper.appendChild(messageBubble);
            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            return messageWrapper;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('chat-toggle').addEventListener('click', toggleChat);
            document.getElementById('chat-form').addEventListener('submit', function (e) {
                e.preventDefault();
                sendChat();
            });
        });

        // Sayfa yÃ¼klendiÄŸinde ilk render'Ä± yap
        renderAll();


    </script>


</body>
</html>